<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Campaign Feed</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #26212B;
        }
        .profile-selection-glow:hover {
            box-shadow: 0 0 15px currentColor;
        }
        .post-card {
            background-color: #1B171E;
        }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        /* Custom scrollbar for better dark mode aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        #new-post-btn:hover {
            filter: brightness(0.9);
        }
    </style>
</head>
<body class="text-white antialiased">

    <!-- App Container -->
    <div id="app-container" class="max-w-md mx-auto h-screen flex flex-col">

        <!-- Login Screen -->
        <div id="login-screen" class="flex flex-col items-center justify-center h-full p-8 text-center">
            <h1 class="text-3xl font-bold mb-4">Choose Your Character</h1>
            <p class="text-gray-400 mb-12">Tap your character's color to log in.</p>
            <div class="grid grid-cols-2 gap-8">
                <div data-color="green" data-name="Green Ranger" class="w-32 h-32 bg-green-500 rounded-full cursor-pointer flex items-center justify-center text-xl font-bold transition-transform transform hover:scale-110 profile-selection-glow" style="color: #10B981;"></div>
                <div data-color="brown" data-name="Brown Berserker" class="w-32 h-32 bg-yellow-700 rounded-full cursor-pointer flex items-center justify-center text-xl font-bold transition-transform transform hover:scale-110 profile-selection-glow" style="color: #D97706;"></div>
                <div data-color="purple" data-name="Purple Mage" class="w-32 h-32 bg-purple-600 rounded-full cursor-pointer flex items-center justify-center text-xl font-bold transition-transform transform hover:scale-110 profile-selection-glow" style="color: #9333EA;"></div>
                <div data-color="blue" data-name="Blue Rogue" class="w-32 h-32 bg-blue-500 rounded-full cursor-pointer flex items-center justify-center text-xl font-bold transition-transform transform hover:scale-110 profile-selection-glow" style="color: #3B82F6;"></div>
            </div>
             <p id="auth-status" class="mt-8 text-sm text-gray-500">Connecting...</p>
        </div>

        <!-- Main App Screen -->
        <div id="main-app-screen" class="hidden h-full w-full flex-col">
            <!-- Header -->
            <header class="flex items-center justify-between p-4 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-700" style="background-color: rgba(38, 33, 43, 0.8);">
                <div class="flex items-center gap-3">
                    <div id="user-avatar" class="w-8 h-8 rounded-full"></div>
                    <span id="user-name" class="font-semibold"></span>
                </div>
                <button id="logout-button" title="Log Out">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400 hover:text-white"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </header>

            <!-- Feed -->
            <main id="feed-container" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Posts will be injected here -->
            </main>

            <!-- New Post Button -->
            <div class="p-4">
                 <button id="new-post-btn" class="w-full text-white font-bold py-4 px-4 rounded-full shadow-lg transition-all transform hover:scale-105" style="background-color: #7F3BC3;">
                    + New Post
                </button>
            </div>
        </div>

        <!-- New Post Modal -->
        <div id="new-post-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
            <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-sm m-4">
                <div class="p-4 border-b border-gray-700">
                    <h3 class="text-lg font-semibold">Create a new post</h3>
                </div>
                <div class="p-4">
                    <div id="pasted-image-preview-container" class="mb-2 hidden">
                         <img id="pasted-image-preview" class="max-h-40 rounded-lg w-auto mx-auto" src="" />
                         <button id="remove-image-btn" class="w-full text-sm text-red-500 hover:underline mt-2">Remove Image</button>
                    </div>
                    <textarea id="post-textarea" class="w-full h-32 bg-gray-700 border border-gray-600 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-purple-500 resize-none" placeholder="What's happening in the campaign? You can also paste an image."></textarea>
                </div>
                <div class="p-4 flex justify-end gap-2 bg-gray-800 rounded-b-lg">
                    <button id="discard-post-btn" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md font-semibold">Discard</button>
                    <button id="send-post-btn" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-md font-semibold disabled:bg-purple-900 disabled:cursor-not-allowed" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Config ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..." };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'dnd-feed-app';
        
        // --- App State ---
        let app, auth, db, storage;
        let currentUser = null;
        let pastedImageData = null;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const mainAppScreen = document.getElementById('main-app-screen');
        const authStatus = document.getElementById('auth-status');
        const feedContainer = document.getElementById('feed-container');
        const userAvatar = document.getElementById('user-avatar');
        const userName = document.getElementById('user-name');
        
        const newPostBtn = document.getElementById('new-post-btn');
        const newPostModal = document.getElementById('new-post-modal');
        const postTextarea = document.getElementById('post-textarea');
        const discardPostBtn = document.getElementById('discard-post-btn');
        const sendPostBtn = document.getElementById('send-post-btn');
        const logoutButton = document.getElementById('logout-button');
        
        const pastedImagePreviewContainer = document.getElementById('pasted-image-preview-container');
        const pastedImagePreview = document.getElementById('pasted-image-preview');
        const removeImageBtn = document.getElementById('remove-image-btn');


        // --- Helper Functions ---
        const timeAgo = (timestamp) => {
            if (!timestamp) return 'just now';
            const now = new Date();
            const seconds = Math.floor((now - timestamp.toDate()) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " years ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " months ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " days ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " hours ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " minutes ago";
            return Math.floor(seconds) < 5 ? 'just now' : Math.floor(seconds) + ' seconds ago';
        };

        const getColorClasses = (color) => {
            const map = {
                green: { bg: 'bg-green-500', text: 'text-green-400' },
                brown: { bg: 'bg-yellow-700', text: 'text-yellow-500' },
                purple: { bg: 'bg-purple-600', text: 'text-purple-400' },
                blue: { bg: 'bg-blue-500', text: 'text-blue-400' },
            };
            return map[color] || { bg: 'bg-gray-500', text: 'text-gray-400' };
        };

        const renderPosts = (posts) => {
            feedContainer.innerHTML = '';
            if (posts.length === 0) {
                 feedContainer.innerHTML = `<div class="text-center text-gray-500 mt-10">
                    <p class="text-lg">The feed is empty.</p>
                    <p>Be the first to post about your adventure!</p>
                </div>`;
                return;
            }
            posts.forEach(post => {
                const colorClasses = getColorClasses(post.authorColor);
                const postElement = document.createElement('div');
                postElement.className = 'p-4 rounded-lg post-card';
                postElement.dataset.id = post.id;

                const likes = post.likes || [];
                const likeCount = likes.length;
                const isLiked = currentUser && likes.includes(currentUser.userId);

                postElement.innerHTML = `
                    <div class="flex items-start">
                        <div class="w-10 h-10 ${colorClasses.bg} rounded-full mr-3 shrink-0"></div>
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold ${colorClasses.text}">${post.authorName}</p>
                                    <p class="text-xs text-gray-400">${timeAgo(post.timestamp)}</p>
                                </div>
                                <div class="like-button flex items-center gap-2 text-gray-400 cursor-pointer transition-colors hover:text-white">
                                    <span class="like-count font-medium">${likeCount}</span>
                                    <svg class="like-heart" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="${isLiked ? '#FF70A2' : 'none'}" stroke="${isLiked ? '#FF70A2' : 'currentColor'}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                                </div>
                            </div>
                            <p class="text-gray-300 whitespace-pre-wrap mt-2">${post.text || ''}</p>
                            ${post.imageUrl ? `<img src="${post.imageUrl}" class="mt-3 rounded-lg w-full h-auto object-cover"/>` : ''}
                        </div>
                    </div>
                `;
                feedContainer.appendChild(postElement);
            });
        };
        
        const showView = (view) => {
            loginScreen.classList.add('hidden');
            mainAppScreen.classList.add('hidden');
            document.getElementById(view).classList.remove('hidden');
            if(view === 'main-app-screen') {
                 document.getElementById(view).classList.add('flex');
            }
        };

        const setupUIForUser = (userProfile) => {
            currentUser = userProfile;
            userName.textContent = userProfile.name;
            const colorClasses = getColorClasses(userProfile.color);
            userAvatar.className = `w-8 h-8 rounded-full ${colorClasses.bg}`;
            showView('main-app-screen');
        };

        // --- Event Listeners ---
        loginScreen.addEventListener('click', async (e) => {
            if (e.target.dataset.color) {
                const { color, name } = e.target.dataset;
                const userProfile = { name, color, userId: auth.currentUser.uid };
                const userDocRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
                await setDoc(userDocRef, userProfile);
                setupUIForUser(userProfile);
            }
        });

        logoutButton.addEventListener('click', async () => {
             // In this simple app, "logging out" means clearing the user profile choice.
             // We can't truly sign out of anonymous/custom auth and then sign back in as the same user.
             // So we'll delete their profile choice to force re-selection.
            const userDocRef = doc(db, `artifacts/${appId}/users`, auth.currentUser.uid);
            await setDoc(userDocRef, {deleted: true}); // A soft delete
            currentUser = null;
            showView('login-screen');
        });

        feedContainer.addEventListener('click', async (e) => {
            const likeButton = e.target.closest('.like-button');
            if (likeButton && currentUser) {
                const postElement = e.target.closest('.post-card');
                const postId = postElement.dataset.id;
                if (!postId) return;

                const postDocRef = doc(db, `artifacts/${appId}/public/data/posts`, postId);
                const postDoc = await getDoc(postDocRef);
                if (!postDoc.exists()) return;

                const postData = postDoc.data();
                const likes = postData.likes || [];
                
                if (likes.includes(currentUser.userId)) {
                    await updateDoc(postDocRef, { likes: arrayRemove(currentUser.userId) });
                } else {
                    await updateDoc(postDocRef, { likes: arrayUnion(currentUser.userId) });
                }
            }
        });

        newPostBtn.addEventListener('click', () => newPostModal.classList.remove('hidden'));
        discardPostBtn.addEventListener('click', () => {
            newPostModal.classList.add('hidden');
            postTextarea.value = '';
            pastedImageData = null;
            pastedImagePreviewContainer.classList.add('hidden');
        });

        sendPostBtn.addEventListener('click', async () => {
            const text = postTextarea.value.trim();
            if (!text && !pastedImageData) return;

            sendPostBtn.disabled = true;
            sendPostBtn.textContent = 'Sending...';

            let imageUrl = null;
            try {
                if (pastedImageData) {
                    const userId = auth.currentUser.uid;
                    if (!userId) throw new Error("User not authenticated for image upload.");
                    
                    const storageRef = ref(storage, `artifacts/${appId}/public/images/${Date.now()}-${Math.random().toString(36).substring(2)}`);
                    const uploadResult = await uploadString(storageRef, pastedImageData, 'data_url');
                    imageUrl = await getDownloadURL(uploadResult.ref);
                }

                const newPost = {
                    authorName: currentUser.name,
                    authorColor: currentUser.color,
                    authorId: auth.currentUser.uid,
                    text: text,
                    imageUrl: imageUrl, // Save the URL instead of the data
                    timestamp: serverTimestamp(),
                    likes: [] // Initialize likes as an empty array
                };

                await addDoc(collection(db, `artifacts/${appId}/public/data/posts`), newPost);

            } catch(error) {
                console.error("Error creating post: ", error);
                // Maybe show an error to the user here
            } finally {
                newPostModal.classList.add('hidden');
                postTextarea.value = '';
                pastedImageData = null;
                pastedImagePreviewContainer.classList.add('hidden');
                pastedImagePreview.src = '';
                sendPostBtn.textContent = 'Send';
            }
        });

        postTextarea.addEventListener('input', () => {
            sendPostBtn.disabled = postTextarea.value.trim().length === 0 && !pastedImageData;
        });

        postTextarea.addEventListener('paste', (event) => {
            const items = (event.clipboardData || event.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') === 0) {
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // We still use the base64 data for the preview and upload
                        pastedImageData = e.target.result; 
                        pastedImagePreview.src = pastedImageData;
                        pastedImagePreviewContainer.classList.remove('hidden');
                        sendPostBtn.disabled = false;
                    };
                    reader.readAsDataURL(blob);
                }
            }
        });

        removeImageBtn.addEventListener('click', () => {
            pastedImageData = null;
            pastedImagePreview.src = '';
            pastedImagePreviewContainer.classList.add('hidden');
            sendPostBtn.disabled = postTextarea.value.trim().length === 0;
        });

        // --- Initialization ---
        const initialize = async () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            storage = getStorage(app); // Initialize Firebase Storage

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authStatus.textContent = 'Checking character...';
                    const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists() && !userDoc.data().deleted) {
                        setupUIForUser(userDoc.data());
                    } else {
                        authStatus.textContent = 'Ready!';
                        showView('login-screen');
                    }
                    
                    // Start listening for posts in real-time
                    const postsCollection = collection(db, `artifacts/${appId}/public/data/posts`);
                    onSnapshot(postsCollection, (querySnapshot) => {
                        const posts = [];
                        querySnapshot.forEach((doc) => {
                            posts.push({ id: doc.id, ...doc.data() });
                        });
                        // Sort client-side to avoid needing a composite index in Firestore
                        posts.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));
                        renderPosts(posts);
                    });

                } else {
                    authStatus.textContent = 'Authentication failed. Please refresh.';
                }
            });

            try {
                authStatus.textContent = 'Authenticating...';
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication Error: ", error);
                authStatus.textContent = 'Could not connect. Please refresh the page.';
            }
        };

        initialize();
    </script>
</body>
</html>

